#include <stdio.h>
#include <omp.h>
#include <sys/time.h>
#include <cuda.h>
#include <cuda_runtime.h>
#include <cuda_runtime_api.h>
#include <driver_types.h>
#include <device_launch_parameters.h>

// device code
__global__
void diffusion(int* u, int r, int size, int iter) {
	
	int i = threadIdx.x;
	int j = threadIdx.y;
	for (int time = 0; time < iter; time++) {
		float upper, lower, left, right;
		if (i != 0 && i != size - 1 && j != 0 && j != size - 1) {
			upper = u[(i - 1) * size + j];
			lower = u[(i + 1) * size + j];
			left  = u[i * size + j - 1];
			right = u[i * size + j + 1];
		}
		__syncthreads();
		if (i != 0 && i != size - 1 && j != 0 && j != size - 1) {
			u[i][j] = (1 - 4 * r) * u[i][j] + r * (upper + lower + left + right);
		}
		__syncthreads();
	}
}

//host code
__host__
int main() {
    struct timeval tv_before, tv_after;
	int size = 10;
	int iter = 100;
	float u[10 * 10] = {0};
	float r = 0.2;
	for (int i = 1; i < size - 1; i++) {
		for (int j = 1; j < size - 1; j++) {
			u[i * size + j] = 1.0;
		}
	}
	float *address;
	const int fsize = size * size * sizeof(float);
	cudaMalloc((void**)&address, fsize);
	cudaMemcpy(address, u, fsize, cudaMemcpyHostToDevice);
	dim3 threadsPerBlock(size * size, 1);
	dim3 numBlocks(1, 1);
	gettimeofday(&tv_before, NULL);

	diffusion<<<numBlocks, threadsPerBlock>>>(address, r, size, iter);
	
	gettimeofday(&tv_after, NULL);
	cudaMemcpy(u, address, fsize, cudaMemcpyDeviceToHost);
	cudaFree(address);
	for (int i = 0; i < size; i++) {
		for (int j = 0; j < size; j++) {
			int color = (int)(u[i * size + j] * 255);
			printf("\033[48;2;%d;%d;255m  ", color, color);
			//printf("%.3f ", u[0][i][j]); //数値をdump
		}
		printf("\n");
	}
	printf("\033[0m\n");
	printf("time : %ld sec + %06lu usec\n", 
			tv_after.tv_sec - tv_before.tv_sec, 
			tv_after.tv_usec - tv_before.tv_usec);
}
